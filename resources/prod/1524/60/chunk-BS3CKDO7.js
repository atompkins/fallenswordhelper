import{a as pe}from"./chunk-ZRNYOYUN.js";import{a as fe}from"./chunk-YAKSYFWS.js";import{a as le}from"./chunk-FPCCSGLA.js";import{a as A}from"./chunk-TVKHDN3I.js";import{a as ce}from"./chunk-V3MST2FC.js";import{a as m}from"./chunk-YVOMHLFA.js";import{a as me}from"./chunk-KL44QB5G.js";import{a as ie}from"./chunk-EO4FR2AE.js";import{a as J}from"./chunk-B6UVYP43.js";import{a as X}from"./chunk-WUCE7CZ7.js";import{a as oe,b as P}from"./chunk-ZANBUYIU.js";import{a as ee}from"./chunk-4OECCVG4.js";import{b as d}from"./chunk-5NBSFLUX.js";import{a as ne}from"./chunk-LZ6APVKA.js";import{a as w}from"./chunk-7B4IO7C5.js";import{a as F}from"./chunk-Q4XXYB5L.js";import{a as Z}from"./chunk-M2EZ4FGP.js";import{a as s}from"./chunk-L5AX3Z7V.js";import{a as T}from"./chunk-PZPCKQA2.js";import{a as S}from"./chunk-JXDCVDAG.js";import{a as x}from"./chunk-3GV55PFT.js";import{a as K}from"./chunk-S6Z6AK6H.js";import{a as ae}from"./chunk-INSIMFVG.js";import{a as se}from"./chunk-V7EDYNK5.js";import{a as re}from"./chunk-7D7PUCSG.js";import{a as te}from"./chunk-NTW3JDM6.js";import{a as Q}from"./chunk-QARH3V57.js";import{a as U}from"./chunk-E5FOTTRM.js";import{a as W}from"./chunk-HVPMEAYK.js";import{a as f}from"./chunk-Q6VOFYH2.js";import{a as n}from"./chunk-QH6YIHH4.js";import{a as l}from"./chunk-IJUADRFJ.js";import{b}from"./chunk-VEFZUGNI.js";import{Ia as z,Ja as O,Ka as h,R as Y,ra as L,t as N}from"./chunk-OOFTOHPO.js";import{a as c}from"./chunk-TQN6MN4F.js";var k;async function we(){return f(await fe(!1)).filter(([,e])=>W(e)).map(([e])=>e)}async function g(e){return ee()&&!k&&(k=we()),(await k).includes(e)}var xe=e=>[e,w(e.href,"target_username")],Ae=async([e,t])=>[e,t,await g(t)],Ce=e=>e?' class="pmAttackUrl"':"";function Le(e,[t,r]){ce(t,` | <a${Ce(e)} href="${Y}${r}">Attack</a>`)}async function v(e,t){let r=n('a[href*="=createsecure&"]',e);if(!r.length)return;let o=r.map(xe);(await Promise.all(o.map(Ae))).filter(([,,i])=>!i).forEach(i=>Le(t,i))}var Pe=e=>e?' class="pmIgnoreUrl"':"",Se=(e,t)=>`<a${Pe(e)} href="${N}${s(t)}" data-tooltip="Add to Ignore List">Ignore</a>`;function ke(e,[t,r]){T(r.cells[1],`<font size="1"><br>[ ${Se(e,t)} ]</font>`)}function E(e,t){let r=n(h,e);if(r.length===0)return;r.map(a=>[a,m(a)]).forEach(a=>ke(t,a))}function _(e){return se({cmd:"combat",subcmd:"view",combat_id:e})}function $(e){return te({cmd:"combat",subcmd:"view",combat_id:e})}function ue(e){return Number(e.getAttribute("background").match(/\/(\d+)/)?.[1])}function p(e,t){let r=new RegExp(`${t} = (\\d+)`);return Number(e.match(r)[1])}var ve=[[18,/(\w+)+ leeched the buff '([A-Za-z ]+)'./],[21,/(\w+)+ was mesmerized by Spell Breaker, losing the '([A-Za-z ]+)' buff./]];function Ee(e){let t=ve.map(([r,o])=>[r,e.match(o)]).find(([,r])=>r);return t?{id:t[0],params:[t[1][1],t[1][2]]}:(Q("Logs","Missing PvP Special",e),{id:-1,params:["-1","-1"]})}function _e(e){return n("#specialsDiv",e).map(s).filter(t=>["leeched","Spell"].some(r=>t.includes(r))).map(Ee)}function $e(e){return{id:ue(e.rows[1].cells[0]),name:s(e.rows[0].cells[0])}}function Re(e){return{id:ue(e.rows[1].cells[2]),name:s(e.rows[0].cells[2])}}function Ge(e,t){let r=t.children[0].rows[5].cells[0].children[0];return{attacker:$e(r),defender:Re(r),id:Number(e),specials:_e(t)}}function qe(e){let t=l(e.children[1]);return{gold_gain:p(t,"goldGain"),gold_stolen:p(t,"goldStolen"),pvp_prestige_gain:p(t,"prestigeGain"),pvp_rating_change:p(t,"pvpRatingChange"),winner:p(t,"winner"),xp_gain:p(t,"xpGain")}}function Me(e,t){return{...Ge(e,t),...qe(t)}}function Be(e,t){let r=re(t),o=U("pCC",r);return{r:Me(e,o),s:!0}}function R(e){return $(e).then(c(Be,e))}function G(e){return ae(_,R,e)}var q="fsh_pvpCombat",M,C;function Ie(e,[t,r]){return t==="lastCheck"||r.logTime&&r.logTime>e}function De(e){let t=d-7*24*60*60,o=f(e).filter(c(Ie,t)),a={...ie(o),lastCheck:d};return P(q,a),a}async function Ve(){let e=await oe(q);if(!e)return{lastCheck:d};let t=d-24*60*60;return!e.lastCheck||e.lastCheck<t?De(e):e}async function je(e,t,r){let o=await G(t);if(!(!o||!o.s))return C||(C={...r}),C[t]={...o,logTime:A(s(e.cells[1]))/1e3},P(q,C),o}async function B(e,t){M||(M=Ve());let r=await M;return r[t]&&r[t].logTime?r[t]:je(e,t,r)}var de="fshGreen",ge="fshRed",He=e=>F(z,e),Ue=([,e])=>!/\(Guild Conflict\)/.test(e),Ne=async([e,t])=>[e,t,await B(e,/combat_id=(\d+)/.exec(t)[1])];function Ye(e,t){return/You were victorious over/.test(t)?[de,`You were <span class="${de}">victorious</span> over `]:/You were defeated by/.test(t)?[ge,`You were <span class="${ge}">defeated</span> by `]:["",l(e.cells[2].firstChild)]}function y(e,t,r){return e!==0?`${t}:<span class="${r}">${X(e)}</span> `:""}function ze(e,t){return t.id===18?`${e}<br><span class="fshRed fshBold">${t.params[0]} leeched the buff '${t.params[1]}'.</span>`:t.id===21?`${e}<br><span class="fshRed fshBold">${t.params[0]} was mesmerized by Spell Breaker, losing the '${t.params[1]}' buff.</span>`:e}function Oe(e,t){return y(e.xp_gain,"XP stolen",t)+y(e.gold_gain,"Gold lost",t)+y(e.gold_stolen,"Gold stolen",t)+y(e.pvp_prestige_gain,"Prestige gain",t)+y(e.pvp_rating_change,"PvP change",t)+e.specials.reduce(ze,"")}function We([e,t,r]){let[o,a]=Ye(e,t),i=Oe(r.r.combat,o);e.cells[2].firstChild.remove(),me(e.cells[2],a),x(e.cells[2],K({innerHTML:i}))}function Ke(e){return e.map(m).filter(He).map(t=>[t,t.cells[2].innerHTML]).filter(Ue).map(Ne)}var Qe=([,,e])=>e&&e.s;async function I(e){let t=n('a[href*="&combat_id="]',e);if(t.length===0)return;(await Promise.all(Ke(t))).filter(Qe).forEach(We)}function D(e){n('a[href*="=trade&"]',e).filter(t=>!w(t.href,"subcmd")).forEach(t=>S("Trade",t)),n('a[href*="=createsecure&"]',e).forEach(t=>S("ST",t))}var ye=e=>e.username,u;async function he(){let e=await le(!1);return{_allies:e._allies.map(ye),_enemies:e._enemies.map(ye)}}async function be(e){return u||(u=he()),(await u)._allies.includes(e)}async function Te(e){return u||(u=he()),(await u)._enemies.includes(e)}function Ze(e,t){let r=e.rows[0].cells[2];r&&!t&&T(r,'&nbsp;&nbsp;<span class="fshWhite">(Guild mates show up in <span class="fshGreen">green</span>)</span>')}async function Xe(e){let t="",r=s(e),[o,a,i]=await Promise.all([g(r),be(r),Te(r)]);return o?t="guild":a?t="ally":i&&(t="enemy"),[`.fshPlayerColoring tr:nth-of-type(${m(e).rowIndex+1}) td:nth-of-type(3) > a:first-of-type`,t]}function Fe(e,[t,r]){return e[r]?e[r].push(t):e[r]=[t],e}var Je={guild:"green",ally:"blue",enemy:"red"};function et([e,t]){return`${t.join(", ")} { color: ${Je[e]}; }`}var tt=([,e])=>e;function rt(e){return f(e.filter(tt).reduce(Fe,{})).map(et)}function ot(e,t,r){let o=rt(t);o.length&&(Ze(e,r),e.classList.add("fshPlayerColoring"),x(document.body,J(o.join(`
`))))}async function V(e,t){let r=n(h,e);if(!r.length)return;let o=await Promise.all(r.map(Xe));ot(e,o,t)}var j,nt=/You ranked \w{3} in your PvP Band! You have gained \d x PvP Ladder Token/;function at(e){return nt.test(l(e.cells[2]))}function st(e){let t=A(s(e.cells[1]));t>j&&(Z(L,t),j=t)}function H(e){j=b(L),n(O,e).map(m).filter(at).forEach(st)}var mt=[["addIgnoreLink",E],["colorPlayerNames",V],["addAttackLinkToLog",v],["changeButtonLabels",D],["trackLadderReset",H],["showPvPSummaryInLog",I]];function it(e,t,r){b(r[0])&&r[1](e,t)}function ct(e,t){mt.forEach(c(it,e,t))}function lt(e){if(ne())return;let t=pe();t&&ct(t,e)}export{lt as a};
//# sourceMappingURL=chunk-BS3CKDO7.js.map
